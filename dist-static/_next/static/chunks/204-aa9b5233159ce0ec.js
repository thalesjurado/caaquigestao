"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[204],{1702:(t,e,a)=>{a.d(e,{E:()=>i,l:()=>l});var o=a(5749);class r{getDefaultRules(){return[{id:"deadline-7-days",name:"Prazo em 7 dias",type:"deadline",enabled:!0,conditions:{daysBeforeDeadline:7},recipients:["all"],message:"O projeto {projectName} tem prazo em 7 dias ({deadline})"},{id:"deadline-3-days",name:"Prazo em 3 dias",type:"deadline",enabled:!0,conditions:{daysBeforeDeadline:3},recipients:["all"],message:"⚠️ URGENTE: O projeto {projectName} tem prazo em 3 dias ({deadline})"},{id:"deadline-today",name:"Prazo hoje",type:"deadline",enabled:!0,conditions:{daysBeforeDeadline:0},recipients:["all"],message:"\uD83D\uDEA8 CR\xcdTICO: O projeto {projectName} tem prazo HOJE ({deadline})"},{id:"overallocation-100",name:"Sobrecarga de equipe",type:"overallocation",enabled:!0,conditions:{allocationThreshold:100},recipients:["management"],message:"⚠️ {collaboratorName} est\xe1 com aloca\xe7\xe3o acima de 100% ({percentage}%)"},{id:"project-completed",name:"Projeto conclu\xeddo",type:"status_change",enabled:!0,conditions:{statusTo:"completed"},recipients:["all"],message:"\uD83C\uDF89 Projeto {projectName} foi conclu\xeddo com sucesso!"},{id:"project-cancelled",name:"Projeto cancelado",type:"status_change",enabled:!0,conditions:{statusTo:"cancelled"},recipients:["management"],message:"❌ Projeto {projectName} foi cancelado"}]}checkDeadlines(t){let e=[],a=new Date,o=this.rules.filter(t=>"deadline"===t.type&&t.enabled);for(let r of t){if("completed"===r.status||"cancelled"===r.status)continue;let t=new Date(r.endDate),l=Math.ceil((t.getTime()-a.getTime())/864e5);for(let i of o){let o=i.conditions.daysBeforeDeadline||0;if(l===o){let c={id:"deadline-".concat(r.id,"-").concat(o),type:l<=0?"error":l<=3?"warning":"info",title:"Alerta de Prazo",message:i.message.replace("{projectName}",r.name).replace("{deadline}",t.toLocaleDateString("pt-BR")),projectId:r.id,createdAt:a,read:!1,actionUrl:"#projects"};e.push(c)}}}return e}checkOverallocation(t,e){let a=[],o=new Date,r=this.rules.filter(t=>"overallocation"===t.type&&t.enabled);for(let l of t){let t=e.filter(t=>t.collaboratorId===l.id&&new Date(t.startDate)<=o&&new Date(t.endDate)>=o).reduce((t,e)=>t+e.percentage,0);for(let e of r)if(t>(e.conditions.allocationThreshold||100)){let r={id:"overallocation-".concat(l.id),type:"warning",title:"Sobrecarga de Equipe",message:e.message.replace("{collaboratorName}",l.name).replace("{percentage}",t.toString()),collaboratorId:l.id,createdAt:o,read:!1,actionUrl:"#availability"};a.push(r)}}return a}checkStatusChanges(t,e){let a=[],o=new Date,r=this.rules.filter(t=>"status_change"===t.type&&t.enabled);for(let l of e){let e=t.find(t=>t.id===l.id);if(e&&e.status!==l.status)for(let t of r){let r=!t.conditions.statusFrom||t.conditions.statusFrom===e.status,i=!t.conditions.statusTo||t.conditions.statusTo===l.status;if(r&&i){let e={id:"status-".concat(l.id,"-").concat(l.status),type:"completed"===l.status?"success":"cancelled"===l.status?"error":"info",title:"Mudan\xe7a de Status",message:t.message.replace("{projectName}",l.name),projectId:l.id,createdAt:o,read:!1,actionUrl:"#projects"};a.push(e)}}}return a}runChecks(t,e,a,o){let r=[];for(let l of(r.push(...this.checkDeadlines(t)),r.push(...this.checkOverallocation(e,a)),o&&r.push(...this.checkStatusChanges(o,t)),r))this.notifications.some(t=>t.id===l.id)||this.addNotification(l)}addNotification(t){this.notifications.unshift(t),this.saveNotifications(),"error"===t.type?o.oR.error(t.message):"warning"===t.type?o.oR.warning(t.message):"success"===t.type&&o.oR.success(t.message)}markAsRead(t){let e=this.notifications.find(e=>e.id===t);e&&(e.read=!0,this.saveNotifications())}markAllAsRead(){this.notifications.forEach(t=>t.read=!0),this.saveNotifications()}removeNotification(t){this.notifications=this.notifications.filter(e=>e.id!==t),this.saveNotifications()}cleanupOldNotifications(){let t=new Date;t.setDate(t.getDate()-30),this.notifications=this.notifications.filter(e=>new Date(e.createdAt)>t),this.saveNotifications()}getNotifications(){return this.notifications}getUnreadNotifications(){return this.notifications.filter(t=>!t.read)}getUnreadCount(){return this.getUnreadNotifications().length}getRules(){return this.rules}updateRule(t,e){let a=this.rules.findIndex(e=>e.id===t);a>=0&&(this.rules[a]={...this.rules[a],...e},this.saveRules())}addCustomRule(t){this.rules.push(t),this.saveRules()}removeRule(t){this.rules=this.rules.filter(e=>e.id!==t),this.saveRules()}startPeriodicCheck(){this.checkInterval=setInterval(()=>{},3e5)}loadRules(){try{let t=localStorage.getItem("caaqui_notification_rules");t?this.rules=JSON.parse(t):(this.rules=this.getDefaultRules(),this.saveRules())}catch(t){this.rules=this.getDefaultRules()}}saveRules(){try{localStorage.setItem("caaqui_notification_rules",JSON.stringify(this.rules))}catch(t){console.warn("Erro ao salvar regras de notifica\xe7\xe3o:",t)}}loadNotifications(){try{let t=localStorage.getItem("caaqui_notifications");t&&(this.notifications=JSON.parse(t).map(t=>({...t,createdAt:new Date(t.createdAt)})))}catch(t){this.notifications=[]}}saveNotifications(){try{localStorage.setItem("caaqui_notifications",JSON.stringify(this.notifications))}catch(t){console.warn("Erro ao salvar notifica\xe7\xf5es:",t)}}destroy(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null)}constructor(){this.rules=[],this.notifications=[],this.checkInterval=null,this.loadRules(),this.loadNotifications(),this.startPeriodicCheck()}}let l=new r;function i(){return{notifications:l.getNotifications(),unreadNotifications:l.getUnreadNotifications(),unreadCount:l.getUnreadCount(),rules:l.getRules(),markAsRead:t=>l.markAsRead(t),markAllAsRead:()=>l.markAllAsRead(),removeNotification:t=>l.removeNotification(t),updateRule:(t,e)=>l.updateRule(t,e),addCustomRule:t=>l.addCustomRule(t),removeRule:t=>l.removeRule(t)}}},2204:(t,e,a)=>{a.d(e,{C:()=>w});var o=a(8693),r=a(2354);let l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oYW5qdnJ4eXdncmVva2tlY2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjcwODMsImV4cCI6MjA3MzU0MzA4M30.XdELUZoogrJnjj3Va_kVwKEBM7GdS30EKGUZHbO3Wvo",i=!!l;i||console.warn("⚠️ Supabase n\xe3o configurado (sem chave v\xe1lida). Usando modo local.");let c=async()=>{if(!i)return!1;try{let{error:t}=await n.from("board_activities").select("id",{count:"exact",head:!0});if(t)return console.warn("⚠️ Supabase indispon\xedvel. Fallback local ativado."),!1;return!0}catch(t){return console.warn("⚠️ Supabase com erro de conex\xe3o. Usando modo local."),!1}},n=(0,r.UU)("https://ohanjvrxywgreokkeckd.supabase.co",l),s={async getAll(){if(!i)return[];let{data:t,error:e}=await n.from("board_activities").select("*").order("created_at",{ascending:!1});if(e)throw console.warn("⚠️ Erro detalhado boardActivities:",{message:e.message,details:e.details,hint:e.hint,code:e.code}),e;return t||[]},async create(t){let{data:e,error:a}=await n.from("board_activities").insert([{...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(a)throw a;return e},async update(t,e){let{data:a,error:o}=await n.from("board_activities").update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("board_activities").delete().eq("id",t);if(e)throw e}},d={async getAll(){if(!i)return[];let{data:t,error:e}=await n.from("collaborators").select("*").order("name",{ascending:!0});if(e)throw console.warn("⚠️ Erro detalhado collaborators:",e),e;return t||[]},async create(t){let{data:e,error:a}=await n.from("collaborators").insert([{id:t.id,name:t.name,email:t.email,role:t.role,avatar:t.avatar}]).select("id,name,email,role,avatar").single();if(a)throw a;return e},async update(t,e){let{data:a,error:o}=await n.from("collaborators").update({name:e.name,email:e.email,role:e.role,avatar:e.avatar}).eq("id",t).select("id,name,email,role,avatar").single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("collaborators").delete().eq("id",t);if(e)throw e}},u={async getAll(){if(!i)return[];let{data:t,error:e}=await n.from("okrs").select("*").order("created_at",{ascending:!1});if(e)throw console.warn("⚠️ Erro detalhado okrs:",e),e;return t||[]},async create(t){let{data:e,error:a}=await n.from("okrs").insert([{...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(a)throw a;return e},async update(t,e){let{data:a,error:o}=await n.from("okrs").update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("okrs").delete().eq("id",t);if(e)throw e}},p={async getAll(){if(!i)return[];let{data:t,error:e}=await n.from("rituals").select("*").order("created_at",{ascending:!1});if(e)throw console.warn("⚠️ Erro detalhado rituals:",e),e;return t||[]},async create(t){let{data:e,error:a}=await n.from("rituals").insert([{...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(a)throw a;return e},async update(t,e){let{data:a,error:o}=await n.from("rituals").update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("rituals").delete().eq("id",t);if(e)throw e}},g={async getAll(){if(!i)return[];try{let{data:e,error:a}=await n.from("projects").select("*").order("created_at",{ascending:!1});if(a){var t;if(console.warn("⚠️ Erro detalhado projects:",a),"PGRST116"===a.code||(null==(t=a.message)?void 0:t.includes("does not exist")))return console.warn("⚠️ Tabela projects n\xe3o encontrada, usando fallback"),[];throw a}return e||[]}catch(t){return console.warn("⚠️ Erro ao acessar projects:",t),[]}},async create(t){try{let{data:e,error:a}=await n.from("projects").insert([{...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(a){console.warn("⚠️ Erro ao criar project no Supabase, salvando no localStorage");let e={...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},a=JSON.parse(localStorage.getItem("caaqui_projects")||"[]");return a.push(e),localStorage.setItem("caaqui_projects",JSON.stringify(a)),e}return e}catch(t){throw console.error("❌ Erro ao criar project:",t),t}},async update(t,e){let{data:a,error:o}=await n.from("projects").update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("projects").delete().eq("id",t);if(e)throw e}},h={async getAll(){if(!i)return[];try{let{data:e,error:a}=await n.from("project_allocations").select("\n          *,\n          projects(name, client),\n          collaborators(name, role)\n        ").order("created_at",{ascending:!1});if(a){var t;if(console.warn("⚠️ Erro detalhado project_allocations:",a),"PGRST116"===a.code||(null==(t=a.message)?void 0:t.includes("does not exist")))return console.warn("⚠️ Tabela project_allocations n\xe3o encontrada, usando fallback"),[];throw a}return e||[]}catch(t){return console.warn("⚠️ Erro ao acessar project_allocations:",t),[]}},async getByProject(t){let{data:e,error:a}=await n.from("project_allocations").select("\n        *,\n        collaborators(name, role, email)\n      ").eq("project_id",t);if(a)throw a;return e||[]},async getByCollaborator(t){let{data:e,error:a}=await n.from("project_allocations").select("\n        *,\n        projects(name, client, end_date)\n      ").eq("collaborator_id",t);if(a)throw a;return e||[]},async create(t){let{data:e,error:a}=await n.from("project_allocations").insert([{...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(a)throw a;return e},async update(t,e){let{data:a,error:o}=await n.from("project_allocations").update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return a},async delete(t){let{error:e}=await n.from("project_allocations").delete().eq("id",t);if(e)throw e}};var m=a(5434),f=a(1702);let j={boardActivity:t=>({id:t.id,title:t.title,status:t.status,assigneeId:t.assignee_id,description:t.description,client:t.client,points:t.points,createdAt:t.created_at?new Date(t.created_at):void 0,subtasks:t.subtasks}),collaborator:t=>({id:t.id,name:t.name,email:t.email,role:t.role,avatar:t.avatar,hourlyRate:t.hourly_rate,accessLevel:t.access_level||"operations",position:t.position||t.role||"Membro"}),okr:t=>({id:t.id,title:t.title,description:t.description,progress:t.progress,quarter:"Q1 2024",activities:t.activities||[]}),ritual:t=>({id:t.id,title:t.title,content:t.content,frequency:t.frequency,nextDate:t.next_date?new Date(t.next_date):void 0,projectId:t.project_id}),project:t=>({id:t.id,name:t.name,client:t.client,type:"tech_implementation"===t.type?"tech":"growth",status:t.status,startDate:new Date(t.start_date),endDate:new Date(t.end_date),description:t.description,budget:t.budget,allocations:[],archivedAt:t.archived_at?new Date(t.archived_at):void 0,techDetails:t.tech_details,growthDetails:t.growth_details}),projectAllocation:t=>({id:t.id,projectId:t.project_id,collaboratorId:t.collaborator_id,percentage:t.percentage,role:t.role,startDate:new Date(t.start_date),endDate:new Date(t.end_date)})},v=!1,b={boardActivity:t=>{var e;return{title:t.title,status:t.status,assignee_id:t.assigneeId,description:t.description,client:t.client,points:t.points,subtasks:t.subtasks,project_id:t.projectId,due_date:null==(e=t.dueDate)?void 0:e.toISOString()}},collaborator:t=>({id:t.id,name:t.name,email:t.email,role:t.role,avatar:t.avatar}),okr:t=>({title:t.title,description:t.description,progress:t.progress,activities:t.activities}),ritual:t=>{var e;return{title:t.title,content:t.content,frequency:t.frequency,next_date:null==(e=t.nextDate)?void 0:e.toISOString(),project_id:t.projectId}},project:t=>{var e,a;return{name:t.name,client:t.client,type:"tech"===t.type?"tech_implementation":"growth_agency",status:"archived"===t.status?"cancelled":t.status,start_date:null==(e=t.startDate)?void 0:e.toISOString(),end_date:null==(a=t.endDate)?void 0:a.toISOString(),description:t.description,budget:t.budget,tech_details:t.techDetails,growth_details:t.growthDetails}},projectAllocation:t=>{var e,a;return{project_id:t.projectId,collaborator_id:t.collaboratorId,percentage:t.percentage,role:t.role,start_date:null==(e=t.startDate)?void 0:e.toISOString(),end_date:null==(a=t.endDate)?void 0:a.toISOString()}}},y=()=>Math.random().toString(36).slice(2)+Date.now().toString(36),A=(()=>{try{let t=localStorage.getItem("caaqui_collaborators");if(!t)return[];let e=JSON.parse(t);return(Array.isArray(null==e?void 0:e.data)?e.data:Array.isArray(e)?e:[])||[]}catch(t){return[]}})(),w=(0,o.vt)()((t,e)=>({boardActivities:[],collaborators:A,okrs:[],rituals:[],projects:[],projectAllocations:[],isLoading:!1,error:null,setLoading:e=>t({isLoading:e}),setError:e=>t({error:e}),setCollaborators:e=>t({collaborators:e}),loadAllData:async()=>{try{var o,r,l,i,b,y,A;if(t({isLoading:!0,error:null}),!await c().catch(()=>!1)){console.warn("⚠️ Supabase indispon\xedvel. Carregando dados do localStorage/fallback.");{let{initializeFallbackData:t}=await a.e(976).then(a.bind(a,3976));t()}}let[w,S,_,O,I,D]=await Promise.all([s.getAll().catch(t=>(console.warn("Aviso ao carregar boardActivities:",t),[])),d.getAll().catch(t=>(console.warn("Aviso ao carregar collaborators:",t),[])),u.getAll().catch(t=>(console.warn("Aviso ao carregar okrs:",t),[])),p.getAll().catch(t=>(console.warn("Aviso ao carregar rituals:",t),[])),g.getAll().catch(t=>(console.warn("Aviso ao carregar projects:",t),[])),h.getAll().catch(t=>(console.warn("Aviso ao carregar project_allocations:",t),[]))]),E=I,R=D,T=w,C=S;if(0===I.length)try{let t=localStorage.getItem("caaqui_projects");if(t)E=JSON.parse(t),console.log("\uD83D\uDCE6 Carregando projects do localStorage:",E.length);else{console.log("\uD83D\uDD04 Inicializando dados de fallback para projects...");let{initializeFallbackData:t}=await a.e(976).then(a.bind(a,3976));t();let e=localStorage.getItem("caaqui_projects");e&&(E=JSON.parse(e),console.log("✅ Dados de fallback criados para projects:",E.length))}}catch(t){console.warn("Erro ao carregar projects do localStorage:",t)}if(0===D.length)try{let t=localStorage.getItem("caaqui_project_allocations");if(t)R=JSON.parse(t),console.log("\uD83D\uDCE6 Carregando project_allocations do localStorage:",R.length);else{console.log("\uD83D\uDD04 Inicializando dados de fallback para project_allocations...");let{initializeFallbackData:t}=await a.e(976).then(a.bind(a,3976));t();let e=localStorage.getItem("caaqui_project_allocations");e&&(R=JSON.parse(e),console.log("✅ Dados de fallback criados para project_allocations:",R.length))}}catch(t){console.warn("Erro ao carregar project_allocations do localStorage:",t)}if(0===w.length)try{(T=(0,m.cY)(m.d5.BOARD_ACTIVITIES)).length>0&&console.log("\uD83D\uDCE6 Carregando board_activities do localStorage:",T.length)}catch(t){console.warn("Erro ao carregar board_activities do localStorage:",t)}if(0===S.length)try{let t=(0,m.cY)(m.d5.COLLABORATORS);t.length>0&&(C=(null==(y=t[0])?void 0:y.accessLevel)||(null==(A=t[0])?void 0:A.position)?t:t.map(j.collaborator),console.log("\uD83D\uDCE6 Carregando collaborators do localStorage:",C.length))}catch(t){console.warn("Erro ao carregar collaborators do localStorage:",t)}let k=e().collaborators||[],N=C.length>0?(null==(o=C[0])?void 0:o.accessLevel)||(null==(r=C[0])?void 0:r.position)?C:C.map(j.collaborator):[],q=(()=>{let t=new Map,e=t=>t.id||t.email||"".concat(t.name,":").concat(t.position||"");for(let a of k)t.set(e(a),a);for(let a of N)t.set(e(a),{...t.get(e(a))||{},...a});return Array.from(t.values())})();try{(0,m.gC)(m.d5.COLLABORATORS,q)}catch(t){}t({boardActivities:T.length>0?(null==(l=T[0])?void 0:l.id)?T.map(j.boardActivity):T:[],collaborators:q,okrs:_.map(j.okr),rituals:O.map(j.ritual),projects:E.length>0?(null==(i=E[0])?void 0:i.id)?E.map(j.project):E:[],projectAllocations:R.length>0?(null==(b=R[0])?void 0:b.id)?R.map(j.projectAllocation):R:[],isLoading:!1});let L=e();if(f.l.runChecks(L.projects,L.collaborators,L.projectAllocations),((t,e)=>{if(!v)try{let a=n.channel("caaqui-db-changes"),o=(t,a)=>{try{var o,r;console.log("[RT]",a,t.eventType,(null==(o=t.new)?void 0:o.id)||(null==(r=t.old)?void 0:r.id))}catch(t){}let l=t.eventType,i=t.new,c=t.old;if("projects"===a){if("INSERT"===l){let t=j.project(i);e(e=>({projects:e.projects.some(e=>e.id===t.id)?e.projects.map(e=>e.id===t.id?{...e,...t}:e):[...e.projects,t]}))}else if("UPDATE"===l){let t=j.project(i);e(e=>({projects:e.projects.map(e=>e.id===t.id?{...e,...t}:e)}))}else if("DELETE"===l){let t=null==c?void 0:c.id;t&&e(e=>({projects:e.projects.filter(e=>e.id!==t)}))}}if("project_allocations"===a){if("INSERT"===l){let t=j.projectAllocation(i);e(e=>({projectAllocations:e.projectAllocations.some(e=>e.id===t.id)?e.projectAllocations.map(e=>e.id===t.id?{...e,...t}:e):[...e.projectAllocations,t]}))}else if("UPDATE"===l){let t=j.projectAllocation(i);e(e=>({projectAllocations:e.projectAllocations.map(e=>e.id===t.id?{...e,...t}:e)}))}else if("DELETE"===l){let t=null==c?void 0:c.id;t&&e(e=>({projectAllocations:e.projectAllocations.filter(e=>e.id!==t)}))}}if("board_activities"===a){if("INSERT"===l){let t=j.boardActivity(i);e(e=>({boardActivities:e.boardActivities.some(e=>e.id===t.id)?e.boardActivities.map(e=>e.id===t.id?{...e,...t}:e):[...e.boardActivities,t]}))}else if("UPDATE"===l){let t=j.boardActivity(i);e(e=>({boardActivities:e.boardActivities.map(e=>e.id===t.id?{...e,...t}:e)}))}else if("DELETE"===l){let t=null==c?void 0:c.id;t&&e(e=>({boardActivities:e.boardActivities.filter(e=>e.id!==t)}))}}if("rituals"===a){if("INSERT"===l){let t=j.ritual(i);e(e=>({rituals:e.rituals.some(e=>e.id===t.id)?e.rituals.map(e=>e.id===t.id?{...e,...t}:e):[...e.rituals,t]}))}else if("UPDATE"===l){let t=j.ritual(i);e(e=>({rituals:e.rituals.map(e=>e.id===t.id?{...e,...t}:e)}))}else if("DELETE"===l){let t=null==c?void 0:c.id;t&&e(e=>({rituals:e.rituals.filter(e=>e.id!==t)}))}}if("collaborators"===a){if("INSERT"===l){let t=j.collaborator(i);e(e=>({collaborators:e.collaborators.some(e=>e.id===t.id)?e.collaborators.map(e=>e.id===t.id?{...e,...t}:e):[...e.collaborators,t]}))}else if("UPDATE"===l){let t=j.collaborator(i);e(e=>({collaborators:e.collaborators.map(e=>e.id===t.id?{...e,...t}:e)}))}else if("DELETE"===l){let t=null==c?void 0:c.id;t&&e(e=>({collaborators:e.collaborators.filter(e=>e.id!==t)}))}}};a.on("postgres_changes",{event:"*",schema:"public",table:"projects"},t=>o(t,"projects")).on("postgres_changes",{event:"*",schema:"public",table:"project_allocations"},t=>o(t,"project_allocations")).on("postgres_changes",{event:"*",schema:"public",table:"board_activities"},t=>o(t,"board_activities")).on("postgres_changes",{event:"*",schema:"public",table:"rituals"},t=>o(t,"rituals")).on("postgres_changes",{event:"*",schema:"public",table:"collaborators"},t=>o(t,"collaborators")).subscribe(async a=>{if("SUBSCRIBED"===a){console.log("\uD83D\uDD14 Realtime conectado");try{let[a,o]=await Promise.all([d.getAll().catch(()=>[]),h.getAll().catch(()=>[])]);e(t=>({collaborators:Array.isArray(a)&&a.length>0?a.map(j.collaborator):t.collaborators,projectAllocations:Array.isArray(o)&&o.length>0?o.map(j.projectAllocation):t.projectAllocations}));let r=0,l=async()=>{var a,o;r++;let i=t(),c=0===((null==(a=i.collaborators)?void 0:a.length)||0),n=0===((null==(o=i.projectAllocations)?void 0:o.length)||0);if(c||n){try{let[t,a]=await Promise.all([c?d.getAll().catch(()=>[]):Promise.resolve([]),n?h.getAll().catch(()=>[]):Promise.resolve([])]);if((null==t?void 0:t.length)>0||(null==a?void 0:a.length)>0)return void e(e=>({collaborators:(null==t?void 0:t.length)>0?t.map(j.collaborator):e.collaborators,projectAllocations:(null==a?void 0:a.length)>0?a.map(j.projectAllocation):e.projectAllocations}))}catch(t){}r<6&&setTimeout(l,5e3)}};setTimeout(l,5e3)}catch(t){console.warn("⚠️ Falha ao hidratar ap\xf3s SUBSCRIBED:",t)}}}),v=!0}catch(t){console.warn("⚠️ Falha ao iniciar Realtime:",t)}})(e,t),0===q.length)try{let e=localStorage.getItem("caaqui_collaborators");if(e){let a=JSON.parse(e),o=Array.isArray(null==a?void 0:a.data)?a.data:Array.isArray(a)?a:[];o.length>0&&(t({collaborators:o}),(0,m.gC)(m.d5.COLLABORATORS,o))}}catch(t){}}catch(e){console.error("Erro geral ao carregar dados:",e),t({error:"Erro ao conectar com Supabase: ".concat(e.message),isLoading:!1})}},addBoardActivity:async(e,a)=>{try{var o;let r={id:y(),title:e,status:null!=(o=null==a?void 0:a.status)?o:"todo",assignee_id:null==a?void 0:a.assigneeId,description:null==a?void 0:a.description,client:null==a?void 0:a.client,project_id:null==a?void 0:a.projectId,points:null==a?void 0:a.points,subtasks:null==a?void 0:a.subtasks,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};try{let e=await s.create(r),a=j.boardActivity(e);t(t=>({boardActivities:[...t.boardActivities,a]}))}catch(o){console.warn("⚠️ Erro ao criar atividade no Supabase, usando localStorage");let e=(0,m.cY)(m.d5.BOARD_ACTIVITIES);e.push(r),(0,m.gC)(m.d5.BOARD_ACTIVITIES,e);let a=j.boardActivity(r);t(t=>({boardActivities:[...t.boardActivities,a]}))}}catch(e){console.error("Erro ao adicionar atividade:",e),t({error:"Erro ao adicionar atividade"})}},updateBoardActivity:async(e,a)=>{try{try{let o=b.boardActivity(a),r=await s.update(e,o),l=j.boardActivity(r);t(t=>({boardActivities:t.boardActivities.map(t=>t.id===e?{...t,...l}:t)}))}catch(l){console.warn("⚠️ Erro ao atualizar atividade no Supabase, usando localStorage");let o={...a,id:e,updatedAt:new Date};t(t=>({boardActivities:t.boardActivities.map(t=>t.id===e?{...t,...o}:t)}));let r=(0,m.cY)(m.d5.BOARD_ACTIVITIES).map(t=>t.id===e?{...t,...b.boardActivity(o)}:t);(0,m.gC)(m.d5.BOARD_ACTIVITIES,r)}}catch(e){console.error("Erro ao atualizar atividade:",e),t({error:"Erro ao atualizar atividade"})}},deleteBoardActivity:async e=>{try{try{await s.delete(e)}catch(a){console.warn("⚠️ Erro ao deletar atividade no Supabase, usando localStorage");let t=(0,m.cY)(m.d5.BOARD_ACTIVITIES).filter(t=>t.id!==e);(0,m.gC)(m.d5.BOARD_ACTIVITIES,t)}t(t=>({boardActivities:t.boardActivities.filter(t=>t.id!==e)}))}catch(e){console.error("Erro ao deletar atividade:",e),t({error:"Erro ao deletar atividade"})}},addCollaborator:async a=>{try{let o={id:y(),...a};t(t=>({collaborators:[...t.collaborators,o]})),console.log("\uD83D\uDC65 [addCollaborator] Otimista ->",o);try{let t=(0,m.cY)(m.d5.COLLABORATORS);t.push(o),(0,m.gC)(m.d5.COLLABORATORS,t)}catch(t){}try{let a=b.collaborator(o),r=await d.create(a),l=j.collaborator(r);t(t=>({collaborators:t.collaborators.map(t=>t.id===o.id?{...t,...l}:t)})),console.log("\uD83D\uDC65 [addCollaborator] Persistido no Supabase, convertido ->",l);try{let t=e().collaborators;(0,m.gC)(m.d5.COLLABORATORS,t)}catch(t){}}catch(e){console.warn("⚠️ Erro ao criar colaborador no Supabase, usando localStorage");let t=(0,m.cY)(m.d5.COLLABORATORS);t.push(o),(0,m.gC)(m.d5.COLLABORATORS,t),console.log("\uD83D\uDCBE [addCollaborator] Salvo no localStorage. Total local ->",t.length)}}catch(e){console.error("Erro ao adicionar colaborador:",e),t({error:"Erro ao adicionar colaborador"})}},updateCollaborator:async(a,o)=>{try{try{let r=b.collaborator(o),l=await d.update(a,r),i=j.collaborator(l);t(t=>({collaborators:t.collaborators.map(t=>t.id===a?{...t,...i}:t)}));try{let t=e().collaborators;(0,m.gC)(m.d5.COLLABORATORS,t)}catch(t){}}catch(i){console.warn("⚠️ Erro ao atualizar colaborador no Supabase, usando localStorage");let e={...o,id:a};t(t=>({collaborators:t.collaborators.map(t=>t.id===a?{...t,...e}:t)}));let r=(0,m.cY)(m.d5.COLLABORATORS),l=r.length>0?r.map(t=>t.id===a?{...t,...e}:t):[];l.length>0&&(0,m.gC)(m.d5.COLLABORATORS,l)}}catch(e){console.error("Erro ao atualizar colaborador:",e),t({error:"Erro ao atualizar colaborador"})}},deleteCollaborator:async a=>{try{try{await d.delete(a)}catch(o){console.warn("⚠️ Erro ao deletar colaborador no Supabase, usando localStorage");let t=(0,m.cY)(m.d5.COLLABORATORS),e=t.filter(t=>t.id!==a);t.length!==e.length&&(0,m.gC)(m.d5.COLLABORATORS,e)}t(t=>({collaborators:t.collaborators.filter(t=>t.id!==a)}));try{let t=e().collaborators;(0,m.gC)(m.d5.COLLABORATORS,t)}catch(t){}}catch(e){console.error("Erro ao deletar colaborador:",e),t({error:"Erro ao deletar colaborador"})}},addOKR:async e=>{try{let a={id:y(),...e},o=await u.create(a),r=j.okr(o);t(t=>({okrs:[...t.okrs,r]}))}catch(e){console.error("Erro ao adicionar OKR:",e),t({error:"Erro ao adicionar OKR"})}},updateOKR:async(e,a)=>{try{let o=b.okr(a),r=await u.update(e,o),l=j.okr(r);t(t=>({okrs:t.okrs.map(t=>t.id===e?{...t,...l}:t)}))}catch(e){console.error("Erro ao atualizar OKR:",e),t({error:"Erro ao atualizar OKR"})}},deleteOKR:async e=>{try{await u.delete(e),t(t=>({okrs:t.okrs.filter(t=>t.id!==e)}))}catch(e){console.error("Erro ao deletar OKR:",e),t({error:"Erro ao deletar OKR"})}},addOKRActivity:async(a,o,r)=>{try{let t=e().okrs.find(t=>t.id===a);if(!t)return;let l={id:y(),title:o,assigneeId:r},i=[...t.activities,l];await e().updateOKR(a,{activities:i})}catch(e){console.error("Erro ao adicionar atividade OKR:",e),t({error:"Erro ao adicionar atividade OKR"})}},updateOKRActivity:async(a,o,r)=>{try{let t=e().okrs.find(t=>t.id===a);if(!t)return;let l=t.activities.map(t=>t.id===o?{...t,...r}:t);await e().updateOKR(a,{activities:l})}catch(e){console.error("Erro ao atualizar atividade OKR:",e),t({error:"Erro ao atualizar atividade OKR"})}},deleteOKRActivity:async(a,o)=>{try{let t=e().okrs.find(t=>t.id===a);if(!t)return;let r=t.activities.filter(t=>t.id!==o);await e().updateOKR(a,{activities:r})}catch(e){console.error("Erro ao deletar atividade OKR:",e),t({error:"Erro ao deletar atividade OKR"})}},addRitual:async e=>{try{let a={id:y(),title:e},o=await p.create(a),r=j.ritual(o);t(t=>({rituals:[...t.rituals,r]}))}catch(e){console.error("Erro ao adicionar ritual:",e),t({error:"Erro ao adicionar ritual"})}},updateRitual:async(e,a)=>{try{let o=b.ritual(a),r=await p.update(e,o),l=j.ritual(r);t(t=>({rituals:t.rituals.map(t=>t.id===e?{...t,...l}:t)}))}catch(e){console.error("Erro ao atualizar ritual:",e),t({error:"Erro ao atualizar ritual"})}},deleteRitual:async e=>{try{await p.delete(e),t(t=>({rituals:t.rituals.filter(t=>t.id!==e)}))}catch(e){console.error("Erro ao deletar ritual:",e),t({error:"Erro ao deletar ritual"})}},addProject:async e=>{try{let a={id:y(),...e,createdAt:new Date,updatedAt:new Date};try{let e=b.project(a),o=await g.create(e),r=j.project(o);t(t=>({projects:[...t.projects,r]}))}catch(l){console.warn("⚠️ Erro ao criar projeto no Supabase, usando localStorage");let e=JSON.parse(localStorage.getItem("caaqui_projects")||"[]"),o=b.project(a);e.push(o),localStorage.setItem("caaqui_projects",JSON.stringify(e));let r={...a,allocations:[]};t(t=>({projects:[...t.projects,r]}))}}catch(e){console.error("Erro ao adicionar projeto:",e),t({error:"Erro ao adicionar projeto"})}},updateProject:async(e,a)=>{try{try{let o=b.project(a),r=await g.update(e,o),l=j.project(r);t(t=>({projects:t.projects.map(t=>t.id===e?{...t,...l}:t)}))}catch(l){console.warn("⚠️ Erro ao atualizar no Supabase, usando localStorage");let o={...a,id:e,updatedAt:new Date};t(t=>({projects:t.projects.map(t=>t.id===e?{...t,...o}:t)}));let r=JSON.parse(localStorage.getItem("caaqui_projects")||"[]").map(t=>t.id===e?{...t,...b.project(o)}:t);localStorage.setItem("caaqui_projects",JSON.stringify(r))}}catch(e){console.error("Erro ao atualizar projeto:",e),t({error:"Erro ao atualizar projeto"})}},deleteProject:async a=>{try{try{for(let t of(await h.getByProject(a)).map(t=>t.id))try{await h.delete(t)}catch(t){}}catch(e){let t=JSON.parse(localStorage.getItem("caaqui_project_allocations")||"[]").filter(t=>(t.project_id||t.projectId)!==a);localStorage.setItem("caaqui_project_allocations",JSON.stringify(t))}try{for(let t of e().boardActivities.filter(t=>t.projectId===a))try{await s.delete(t.id)}catch(t){}t(t=>({boardActivities:t.boardActivities.filter(t=>t.projectId!==a)}))}catch(t){}try{await g.delete(a)}catch(e){console.warn("⚠️ Erro ao deletar no Supabase, usando localStorage");let t=JSON.parse(localStorage.getItem("caaqui_projects")||"[]").filter(t=>t.id!==a);localStorage.setItem("caaqui_projects",JSON.stringify(t))}t(t=>({projects:t.projects.filter(t=>t.id!==a),projectAllocations:t.projectAllocations.filter(t=>t.projectId!==a)}))}catch(e){console.error("Erro ao deletar projeto:",e),t({error:"Erro ao deletar projeto"})}},addProjectAllocation:async e=>{try{let a={id:y(),...e};try{let e=b.projectAllocation(a),o=await h.create(e),r=j.projectAllocation(o);t(t=>({projectAllocations:[...t.projectAllocations,r]}))}catch(r){console.warn("⚠️ Erro ao criar aloca\xe7\xe3o no Supabase, usando localStorage");let e=JSON.parse(localStorage.getItem("caaqui_project_allocations")||"[]"),o=b.projectAllocation(a);e.push(o),localStorage.setItem("caaqui_project_allocations",JSON.stringify(e)),t(t=>({projectAllocations:[...t.projectAllocations,a]}))}}catch(e){console.error("Erro ao adicionar aloca\xe7\xe3o:",e),t({error:"Erro ao adicionar aloca\xe7\xe3o"})}},updateProjectAllocation:async(e,a)=>{try{try{let o=b.projectAllocation(a),r=await h.update(e,o),l=j.projectAllocation(r);t(t=>({projectAllocations:t.projectAllocations.map(t=>t.id===e?{...t,...l}:t)}))}catch(l){console.warn("⚠️ Erro ao atualizar aloca\xe7\xe3o no Supabase, usando localStorage");let o={...a,id:e,updatedAt:new Date};t(t=>({projectAllocations:t.projectAllocations.map(t=>t.id===e?{...t,...o}:t)}));let r=JSON.parse(localStorage.getItem("caaqui_project_allocations")||"[]").map(t=>t.id===e?{...t,...b.projectAllocation(o)}:t);localStorage.setItem("caaqui_project_allocations",JSON.stringify(r))}}catch(e){console.error("Erro ao atualizar aloca\xe7\xe3o:",e),t({error:"Erro ao atualizar aloca\xe7\xe3o"})}},deleteProjectAllocation:async e=>{try{try{await h.delete(e)}catch(a){console.warn("⚠️ Erro ao deletar aloca\xe7\xe3o no Supabase, usando localStorage");let t=JSON.parse(localStorage.getItem("caaqui_project_allocations")||"[]").filter(t=>t.id!==e);localStorage.setItem("caaqui_project_allocations",JSON.stringify(t))}t(t=>({projectAllocations:t.projectAllocations.filter(t=>t.id!==e)}))}catch(e){console.error("Erro ao deletar aloca\xe7\xe3o:",e),t({error:"Erro ao deletar aloca\xe7\xe3o"})}},getTeamAvailability:()=>{let t=e(),a=[];return console.log("\uD83D\uDD0D Debug disponibilidade detalhado:"),console.log("- Total collaborators:",t.collaborators.length),console.log("- Total projectAllocations:",t.projectAllocations.length),console.log("- Total projects:",t.projects.length),t.collaborators.forEach(e=>{console.log("\n\uD83D\uDC64 Analisando ".concat(e.name," (").concat(e.id,"):"));let o=new Date,r=t.projectAllocations.filter(t=>t.collaboratorId===e.id);console.log("- Total aloca\xe7\xf5es para ".concat(e.name,":"),r.length),r.forEach(e=>{let a=t.projects.find(t=>t.id===e.projectId),r=new Date(e.endDate)>o;console.log("  • Projeto: ".concat((null==a?void 0:a.name)||"N\xc3O ENCONTRADO"," (").concat(e.projectId,")")),console.log("    - Percentual: ".concat(e.percentage,"%")),console.log("    - Ativo: ".concat(r)),console.log("    - Data fim: ".concat(e.endDate))});let l=r.filter(e=>{let a=t.projects.find(t=>t.id===e.projectId),r=a&&"archived"!==a.status&&"cancelled"!==a.status,l=new Date(e.endDate)>o;return!!a&&r&&l}),i=l.reduce((t,e)=>t+e.percentage,0),c=e.maxAllocation||100,n=l.map(e=>{let a=t.projects.find(t=>t.id===e.projectId);return{projectId:e.projectId,projectName:(null==a?void 0:a.name)||"Projeto n\xe3o encontrado",allocation:e.percentage,endDate:e.endDate}});a.push({collaboratorId:e.id,name:e.name,role:e.role,totalAllocation:Math.min(i,c),availableAllocation:Math.max(0,c-i),projects:n})}),a},getProjectMetrics:()=>{let{projects:t,projectAllocations:a,collaborators:o}=e();return t.map(t=>{let e=a.filter(e=>e.projectId===t.id),r=e.reduce((t,e)=>t+e.percentage,0),l=e.reduce((t,e)=>{let a=o.find(t=>t.id===e.collaboratorId);if(!(null==a?void 0:a.hourlyRate))return t;let r=new Date(e.startDate),l=Math.ceil((new Date(e.endDate).getTime()-r.getTime())/6048e5);return t+e.percentage/100*40*l*a.hourlyRate},0),i=new Date(t.startDate),c=new Date(t.endDate),n=new Date,s=Math.ceil((c.getTime()-i.getTime())/864e5),d=Math.ceil((n.getTime()-i.getTime())/864e5),u=Math.ceil((c.getTime()-n.getTime())/864e5),p=Math.min(100,Math.max(0,d/s*100));return{id:t.id,name:t.name,status:t.status,progressPct:p,daysRemaining:u,isOnTime:u>=0&&p<=100,totalAllocation:r,realCost:l,budgetVariance:t.budget?(l-t.budget)/t.budget*100:0}})},archiveProject:async a=>{try{let t=new Date;await e().updateProject(a,{status:"archived",archivedAt:t})}catch(e){console.error("Erro ao arquivar projeto:",e),t({error:"Erro ao arquivar projeto"})}},restoreProject:async a=>{try{await e().updateProject(a,{status:"active",archivedAt:void 0})}catch(e){console.error("Erro ao restaurar projeto:",e),t({error:"Erro ao restaurar projeto"})}},permanentlyDeleteProject:async a=>{try{await e().deleteProject(a)}catch(e){console.error("Erro ao excluir projeto permanentemente:",e),t({error:"Erro ao excluir projeto permanentemente"})}},cleanupArchivedProjects:async()=>{try{let{projects:t}=e(),a=new Date;a.setDate(a.getDate()-30);let o=t.filter(t=>"archived"===t.status&&t.archivedAt&&t.archivedAt<a);for(let t of o)await e().permanentlyDeleteProject(t.id);console.log("Limpeza autom\xe1tica: ".concat(o.length," projetos removidos"))}catch(t){console.error("Erro na limpeza de projetos arquivados:",t)}},duplicateProject:async(a,o)=>{try{let{projects:t,projectAllocations:r}=e(),l=t.find(t=>t.id===a);if(!l)throw Error("Projeto n\xe3o encontrado");let i={name:o||"".concat(l.name," (C\xf3pia)"),client:l.client,type:l.type,status:"planning",startDate:new Date,endDate:new Date(Date.now()+2592e6),description:l.description,budget:l.budget,techDetails:l.techDetails,growthDetails:l.growthDetails};await e().addProject(i);let{projects:c}=e(),n=c.find(t=>t.name===i.name);if(n)for(let t of r.filter(t=>t.projectId===a)){let a={projectId:n.id,collaboratorId:t.collaboratorId,percentage:t.percentage,role:t.role,startDate:i.startDate,endDate:i.endDate};await e().addProjectAllocation(a)}console.log("Projeto duplicado com sucesso")}catch(e){console.error("Erro ao duplicar projeto:",e),t({error:"Erro ao duplicar projeto"})}},createProjectFromTemplate:async(o,r,l)=>{try{let{getTemplateById:t,createProjectFromTemplate:i}=await a.e(597).then(a.bind(a,8597)),c=t(o);if(!c)throw Error("Template n\xe3o encontrado");let{project:n,tasks:s}=i(c,r,l);await e().addProject(n);let{projects:d}=e(),u=d.find(t=>t.name===r);if(u)for(let t of s)await e().addBoardActivity(t.title,{...t,projectId:u.id});console.log("Projeto criado a partir do template com sucesso")}catch(e){console.error("Erro ao criar projeto a partir do template:",e),t({error:"Erro ao criar projeto a partir do template"})}},duplicateBoardActivity:async a=>{try{let{boardActivities:t}=e(),o=t.find(t=>t.id===a);if(!o)throw Error("Atividade n\xe3o encontrada");let r={title:"".concat(o.title," (C\xf3pia)"),status:"backlog",assigneeId:o.assigneeId,description:o.description,client:o.client,projectId:o.projectId,subtasks:o.subtasks?[...o.subtasks]:void 0};await e().addBoardActivity(r.title,r),console.log("Card duplicado com sucesso")}catch(e){console.error("Erro ao duplicar card:",e),t({error:"Erro ao duplicar card"})}}}))},5434:(t,e,a)=>{a.d(e,{Qx:()=>c,Rz:()=>i,cY:()=>l,d5:()=>o,gC:()=>r});let o={BOARD_ACTIVITIES:"caaqui_board_activities",PROJECTS:"caaqui_projects",PROJECT_ALLOCATIONS:"caaqui_project_allocations",COLLABORATORS:"caaqui_collaborators",OKRS:"caaqui_okrs",RITUALS:"caaqui_rituals",LAST_SYNC:"caaqui_last_sync"};function r(t,e,a){try{let r={timestamp:new Date().toISOString(),data:e,userId:a};localStorage.setItem(t,JSON.stringify(r)),localStorage.setItem(o.LAST_SYNC,new Date().toISOString());let l=Array.isArray(e)?e.length:"object"==typeof e&&null!==e?Object.keys(e).length:1;console.log("\uD83D\uDCBE Dados salvos em ".concat(t,":"),l,"itens")}catch(t){console.error("Erro ao salvar no localStorage:",t)}}function l(t){try{let e=localStorage.getItem(t);if(!e)return[];let a=JSON.parse(e),o=Array.isArray(a.data)?a.data:[];return console.log("\uD83D\uDCE6 Dados carregados de ".concat(t,":"),o.length,"itens"),o}catch(t){return console.error("Erro ao carregar do localStorage:",t),[]}}function i(){try{let t={};Object.values(o).forEach(e=>{let a=l(e);a.length>0&&(t[e]=a)});let e={timestamp:new Date().toISOString(),version:"1.0",data:t},a=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");return i.href=r,i.download="caaqui-backup-".concat(new Date().toISOString().split("T")[0],".json"),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),console.log("\uD83D\uDCE4 Dados exportados com sucesso"),t}catch(t){return console.error("Erro ao exportar dados:",t),{}}}function c(t){try{return Object.entries(t).forEach(t=>{let[e,a]=t;r(e,a)}),console.log("\uD83D\uDCE5 Dados importados com sucesso"),!0}catch(t){return console.error("Erro ao importar dados:",t),!1}}},5749:(t,e,a)=>{a.d(e,{P0:()=>p,Yf:()=>d,oR:()=>u,uU:()=>s});var o=a(2115);let r=new Set,l=[];function i(){r.forEach(t=>t())}function c(t){return r.add(t),()=>r.delete(t)}function n(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,o={id:Math.random().toString(36).slice(2)+Date.now().toString(36),message:t,type:e,duration:a};l=[...l,o],i(),a>0&&setTimeout(()=>{s(o.id)},a)}function s(t){l=l.filter(e=>e.id!==t),i()}function d(){return(0,o.useSyncExternalStore)(c,()=>l,()=>l)}let u={success:t=>n(t,"success"),error:t=>n(t,"error"),warning:t=>n(t,"warning"),info:t=>n(t,"info")},p=n}}]);